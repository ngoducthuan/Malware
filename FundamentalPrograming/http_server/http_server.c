//Compiler using gcc client.c -o client.exe -lws2_32
#include <stdio.h>
//#include <sys/socket.h> Using for socket function if you work on Linux
#include <winsock2.h> //Using for socket function if you work on Windows
//#include <netinet/in.h> Using for AF_NET on Linux
//#include <ws2tcpip.h>//This header file primarily defines structures and constants related to network addressing, such as struct sockaddr_in for IPv4 addresses.
#include<stdlib.h>
#include<string.h>
//#include <arpa/inet.h> // For inet_ntoa function

#define MAX_CONNECT 5

int main(){
    WSADATA wsa;
    int server_socket, client_socket;
    struct sockaddr_in server_addr, client_addr;
    int port = 8080;
    char message[1024];

    //Initialize WinSock
    if(WSAStartup(MAKEWORD(2, 2), &wsa) != 0){
        printf("[-] WSASStartup failed.");
        WSACleanup();
        return 1;
    }

    //Create socket to receive request from user
    //IPPROTO_TCP indicate that the socket will use the TCP protocol
    server_socket = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
    if(server_socket < 0){
        printf("[-] Error creating socket: %d\n", IPPROTO_TCP);
        WSACleanup();
        return 1;
    }else{
        printf("[+] Create socket successful\n");
    }

    //Assign server address struct
    //INADDR_ANY  telling system accept connection on that port from any network interface
    server_addr.sin_family  = AF_INET;
    server_addr.sin_addr.s_addr = INADDR_ANY;
    server_addr.sin_port = htons(port);

    //Bind socket to address and port
    if(bind(server_socket, (struct sockaddr *)&server_addr, sizeof(server_addr)) == SOCKET_ERROR){
        printf("[-] Bind failed.\n");
        closesocket(server_socket);
        WSACleanup();
        exit(1);
    }else{
        printf("[+] Blind successful.\n");
    }

    //Listen connect from client
    if(listen(server_socket, MAX_CONNECT) == SOCKET_ERROR){
        printf("[-] Listen failed.\n");
        closesocket(server_socket);
        WSACleanup();
    }else{
        printf("[+] Server is listening on port 8080...\n");
    }

    //Accept coming connection from client
    int client_addr_size = sizeof(client_addr);
    client_socket = accept(server_socket, (struct sockaddr *)&client_addr, &client_addr_size);
    if (client_socket == INVALID_SOCKET) {
        printf("[-] Accept failed: %d\n", WSAGetLastError());
        closesocket(server_socket);
        WSACleanup();
        return 1;
    }
    printf("[+] Connection accepted from %s:%d\n", inet_ntoa(client_addr.sin_addr), ntohs(client_addr.sin_port));

    // Receive data from client
    int bytes_received = recv(client_socket, message, sizeof(message), 0);
    if (bytes_received == SOCKET_ERROR) {
        printf("[-] Receive failed: %d\n", WSAGetLastError());
        closesocket(client_socket);
        closesocket(server_socket);
        WSACleanup();
        return 1;
    }

    printf("[+] Received: %s\n", message);

    // Send response back to client
    const char *response = "Server is received message.";
    int bytes_sent = send(client_socket, response, strlen(message), 0);
    if (bytes_sent == SOCKET_ERROR) {
        printf("[-] Send failed: %d\n", WSAGetLastError());
        closesocket(client_socket);
        closesocket(server_socket);
        WSACleanup();
        return 1;
    }

    // Close sockets
    closesocket(client_socket);
    closesocket(server_socket);
    WSACleanup();

    return 0;
}
