//gcc .\http_server.c -o .\http_server.exe -lws2_32 -lpthread
//Compiler using gcc client.c -o client.exe -lws2_32
#include <stdio.h>
//#include <sys/socket.h> Using for socket function if you work on Linux
#include <winsock2.h> //Using for socket function if you work on Windows
//#include <netinet/in.h> Using for AF_NET on Linux
//#include <ws2tcpip.h>//This header file primarily defines structures and constants related to network addressing, such as struct sockaddr_in for IPv4 addresses.
#include<stdlib.h>
#include<string.h>
//#include <arpa/inet.h> // For inet_ntoa function
#include <pthread.h>
#include <unistd.h>// khai báo cho các hàm read, write, và close.

#define MAX_CONNECT 5

//Handle more request from more client
void *handle_client(void *arg){
    int client_socket = *((int *)arg);
    char message[1024] = {0};
    int valread;
    // Receive data from client
    valread = recv(client_socket, message, sizeof(message), 0);
    if (valread == SOCKET_ERROR) {
        printf("[-] Error receiving data from client.\n");
        closesocket(client_socket);
        return NULL;
    }

    printf("Received message from client:\n%s\n", message);
    // Check if it's a GET request
    if (strncmp(message, "GET", 3) == 0) {
        // Send HTTP response with a simple HTML page
        char *response = "HTTP/1.1 200 OK\r\nContent-Type: text/html\r\n\r\n"
                         "<html><head><title>Simple HTTP Server</title></head>"
                         "<body><h1>Hello from the HTTP server!</h1></body></html>";
        int bytes_sent = send(client_socket, response, strlen(response), 0);
        if (bytes_sent == SOCKET_ERROR) {
            printf("[-] Error sending response to client.\n");
        }
    } else {
        // Send HTTP response for unsupported request
        char *response = "HTTP/1.1 400 Bad Request\r\nContent-Length: 0\r\n\r\n";
        
    }

    // Close the connection with the client
    closesocket(client_socket);
    printf("Connection with client closed\n");// Close the connection with the client
    return NULL;
}

//Main function
int main(){
    WSADATA wsa;
    int server_socket, client_socket;
    struct sockaddr_in server_addr, client_addr;
    int port = 8080;
    char message[1024];

    //Initialize WinSock
    if(WSAStartup(MAKEWORD(2, 2), &wsa) != 0){
        printf("[-] WSASStartup failed.");
        WSACleanup();
        return 1;
    }

    //Create socket to receive request from user
    //IPPROTO_TCP indicate that the socket will use the TCP protocol
    server_socket = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
    if(server_socket < 0){
        printf("[-] Error creating socket: %d\n", IPPROTO_TCP);
        WSACleanup();
        return 1;
    }else{
        printf("[+] Create socket successful\n");
    }

    //Assign server address struct
    //INADDR_ANY  telling system accept connection on that port from any network interface
    server_addr.sin_family  = AF_INET;
    server_addr.sin_addr.s_addr = INADDR_ANY;
    server_addr.sin_port = htons(port);

    //Bind socket to address and port
    if(bind(server_socket, (struct sockaddr *)&server_addr, sizeof(server_addr)) == SOCKET_ERROR){
        printf("[-] Bind failed.\n");
        closesocket(server_socket);
        WSACleanup();
        exit(1);
    }else{
        printf("[+] Blind successful.\n");
    }

    //Listen connect from client
    if(listen(server_socket, MAX_CONNECT) == SOCKET_ERROR){
        printf("[-] Listen failed.\n");
        closesocket(server_socket);
        WSACleanup();
    }else{
        printf("[+] Server is listening on port 8080...\n");
    }
    while(TRUE){
        //Accept coming connection from client
        char message[1024] = "";
        int client_addr_size = sizeof(client_addr);
        client_socket = accept(server_socket, (struct sockaddr *)&client_addr, &client_addr_size);
        if (client_socket == INVALID_SOCKET) {
            printf("[-] Accept failed: %d\n", WSAGetLastError());
            closesocket(server_socket);
            WSACleanup();
            return 1;
        }
        printf("[+] Connection accepted from %s:%d\n", inet_ntoa(client_addr.sin_addr), ntohs(client_addr.sin_port));
        
        //Create new thread to handle the client
        pthread_attr_t attr;
        pthread_attr_init(&attr);
        pthread_attr_setdetachstate(&attr, PTHREAD_CREATE_DETACHED);
        pthread_t client_thread;
        if(pthread_create(&client_thread, &attr, handle_client, (void *)&client_socket) != 0){
            perror("[-] Thread creation failure.\n");
            closesocket(server_socket);
            WSACleanup();
            return 1;
        }

        // Detach the thread to avoid memory leaks
        // pthread_detach is used to detach a thread
        //Allowing it to run independently without being joined. 
        pthread_detach(client_thread);
    }

    closesocket(server_socket);
    WSACleanup();

    return 0;
}
